name: Auto-Apply to Jobs

on:
  schedule:
  #every 2 hours
    - cron: "0 */2 * * *"
  # Allow manual runs from the GitHub UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual applications)'
        required: false
        default: 'false'
        type: boolean
      max_applications:
        description: 'Maximum applications per run'
        required: false
        default: '10'
        type: string
      skip_csv_commit:
        description: 'Skip committing CSV updates (for testing)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  auto-apply:
    runs-on: ubuntu-latest
    
    steps:
      - name: Protect from paid runners
        run: |
          if [ "${{ runner.os }}" != "Linux" ]; then
            echo "ERROR: Non-free GitHub Runner detected. Stopping."
            exit 1
          fi

      - name: Checkout auto-apply branch (code)
        uses: actions/checkout@v4
        with:
          ref: auto-apply-feature
          fetch-depth: 0

      - name: Checkout main branch (for CSV)
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate user profile from secrets
        run: |
          python scripts/generate_profile_from_secrets.py
        env:
          USER_PROFILE_JSON: ${{ secrets.USER_PROFILE_JSON }}

      - name: Copy CSV from main branch
        run: |
          cp main-branch/data/jobs.csv data/jobs.csv || echo "CSV file not found in main branch, will create new one"

      - name: Run auto-apply (dry-run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          python apply_jobs.py --dry-run --verbose
        env:
          AUTO_APPLY_ENABLED: 'true'
          MAX_APPLICATIONS_PER_RUN: ${{ github.event.inputs.max_applications || '10' }}

      - name: Run auto-apply (actual)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          set -e
          python apply_jobs.py --verbose || {
            echo "Auto-apply failed. Check logs for details."
            exit 1
          }
        env:
          AUTO_APPLY_ENABLED: 'true'
          MAX_APPLICATIONS_PER_RUN: ${{ github.event.inputs.max_applications || '10' }}

      - name: Verify CSV exists and is valid
        if: ${{ github.event.inputs.dry_run != 'true' && github.event.inputs.skip_csv_commit != 'true' }}
        run: |
          if [ ! -f "data/jobs.csv" ]; then
            echo "ERROR: jobs.csv not found after auto-apply"
            exit 1
          fi
          # Basic validation - check if CSV has content
          if [ ! -s "data/jobs.csv" ]; then
            echo "ERROR: jobs.csv is empty"
            exit 1
          fi
          echo "CSV file validated successfully"

      - name: Backup CSV before update
        if: ${{ github.event.inputs.dry_run != 'true' && github.event.inputs.skip_csv_commit != 'true' }}
        run: |
          cp data/jobs.csv data/jobs.csv.backup
          cp data/jobs.csv main-branch/data/jobs.csv
          echo "CSV backed up successfully"

      - name: Commit updated CSV to main branch
        if: ${{ github.event.inputs.dry_run != 'true' && github.event.inputs.skip_csv_commit != 'true' }}
        run: |
          set -euo pipefail

          cd main-branch

          # Configure committer
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Fetch latest main to avoid conflicts
          git fetch origin main || true

          # Check if there are changes
          if git diff --quiet data/jobs.csv 2>/dev/null; then
            echo "No changes to commit in jobs.csv"
            exit 0
          fi

          # Check for conflicts with job scraping workflow
          git pull origin main --rebase || {
            echo "WARNING: Could not rebase. Attempting merge..."
            git pull origin main --no-edit || {
              echo "ERROR: Merge conflict detected. Manual intervention required."
              echo "Please resolve conflicts in data/jobs.csv manually."
              exit 1
            }
          }

          git add data/jobs.csv
          git commit -m "Update jobs.csv with application statuses [auto-apply] $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || {
            echo "No changes to commit (may have been committed by another workflow)"
            exit 0
          }
          git push origin main || {
            echo "ERROR: Failed to push to main branch"
            exit 1
          }
          echo "Successfully committed and pushed CSV updates"

      - name: Upload application logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-apply-logs-${{ github.run_id }}
          path: |
            data/application_logs/
            data/jobs.csv.backup
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "## Auto-Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max Applications**: ${{ github.event.inputs.max_applications || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "data/application_logs/report_*.txt" ]; then
            echo "### Application Report" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat data/application_logs/report_*.txt | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
